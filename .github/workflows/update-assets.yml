name: Update assets.json

permissions:
  contents: write  # gives write permission to the default GITHUB_TOKEN

on:
  push:
    paths:
      - "patterns/**.pdf"
      - "photos/**/*.{png,jpg,jpeg}"
      - ".github/workflows/update-assets.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate assets.json
        run: |
          node -e "
          const fs = require('fs');
          const patternsDir = 'patterns';
          const photosDir = 'photos';

          // Get PDFs from patterns/
          const patternFiles = fs.existsSync(patternsDir) ? fs.readdirSync(patternsDir)
            .filter(f => f.toLowerCase().endsWith('.pdf'))
            .map(f => \`patterns/\${f}\`) : [];

          // Get images from photos/
          const photoFiles = fs.existsSync(photosDir) ? fs.readdirSync(photosDir)
            .filter(f => /\.(png|jpe?g)$/i.test(f))
            .map(f => \`photos/\${f}\`) : [];

          const assets = {
            patterns: patternFiles,
            photos: photoFiles,
          };

          fs.writeFileSync('assets.json', JSON.stringify(assets, null, 2));
          "

      - name: Commit and push changes
        run: |
          git config user.name 'github-actions'
          git config user.email 'github-actions@github.com'
          git add assets.json
          git diff --cached --quiet || git commit -m 'Update assets.json'
          git push origin HEAD:main
